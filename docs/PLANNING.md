# fact-check 콘텐츠 최적화 시스템 - 계획 문서

> **작성일**: 2024-12-21
> **상태**: Planning Phase
> **버전**: v1.0

---

## 1. 프로젝트 개요

### 1.1 목표
GA4 데이터를 기반으로 AI가 자동으로 콘텐츠를 분석하고, A/B 테스트를 통해 지속적으로 성과를 개선하는 자동화 파이프라인 구축

### 1.2 핵심 가치
- **데이터 기반 의사결정**: 감이 아닌 GA4 지표로 콘텐츠 품질 판단
- **자동화**: 3일 주기로 분석 → 가설 → 테스트 → 평가 자동 실행
- **지속적 개선**: A/B 테스트로 검증된 개선만 적용

### 1.3 성공 지표
| 지표 | 현재 | 목표 (6개월) |
|------|------|-------------|
| 평균 체류시간 | 측정 필요 | +30% |
| 스크롤 75% 도달률 | 측정 필요 | +25% |
| 이탈률 | 측정 필요 | -20% |
| A/B 테스트 승률 | N/A | 60%+ |

---

## 2. 현재 상태 (As-Is)

### 2.1 완료된 인프라
```
✅ Cloud SQL (factcheck_db)
   ├── articles (9개 글 마이그레이션 완료)
   ├── ab_tests
   ├── article_metrics
   ├── content_analysis
   └── generation_batches

✅ GA4 (Property ID: 517111075)
   ├── 측정 ID: G-YMWX4H2JFM
   ├── 서비스 계정 권한 부여 완료
   └── API 연결 테스트 성공

✅ Firebase Hosting
   └── https://health-factcheck-web.web.app
```

### 2.2 완료된 코드
```
✅ scripts/
   ├── fetch_ga_metrics.py      # GA4 데이터 수집
   ├── analyze_and_create_ab.py # AI 분석 + A/B 생성
   └── run_optimization_cycle.py # 전체 파이프라인

✅ src/lib/
   ├── db.ts                    # DB 연결
   ├── content-db.ts            # A/B 지원 콘텐츠 API
   └── middleware.ts            # A/B 쿠키 설정
```

### 2.3 미완료 항목
```
❌ Next.js 실제 DB 연동 (현재 MDX 파일 사용 중)
❌ Cloud Scheduler 배포
❌ OpenAI API 연동 테스트
❌ A/B 테스트 결과 자동 평가
❌ 승자 버전 자동 승격
❌ Notion 연동 (결과 리포트)
```

---

## 3. 목표 상태 (To-Be)

### 3.1 전체 아키텍처
```
┌─────────────────────────────────────────────────────────────────────┐
│                     fact-check 콘텐츠 최적화 시스템                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                     사용자 접속 레이어                         │  │
│  │                                                              │  │
│  │   사용자 ──▶ Firebase Hosting ──▶ Next.js (SSG)              │  │
│  │                     │                                        │  │
│  │                     ▼                                        │  │
│  │              A/B 트래픽 분배 (쿠키 기반)                       │  │
│  │                   │                                          │  │
│  │          ┌────────┴────────┐                                 │  │
│  │          ▼                 ▼                                 │  │
│  │     A 버전 (원본)     B 버전 (개선)                           │  │
│  │                                                              │  │
│  │                     │                                        │  │
│  │                     ▼                                        │  │
│  │              GA4 데이터 수집                                  │  │
│  │     (체류시간, 스크롤깊이, 이탈률)                             │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    3일 주기 자동화 레이어                      │  │
│  │                                                              │  │
│  │   Cloud Scheduler (매 3일 오전 6시)                           │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │   ┌─────────────┐                                            │  │
│  │   │ Phase 1     │  GA4 Data API                              │  │
│  │   │ 데이터 수집  │ ──────────▶ article_metrics 테이블         │  │
│  │   └─────────────┘                                            │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │   ┌─────────────┐                                            │  │
│  │   │ Phase 2     │  하위 20% 글 추출                           │  │
│  │   │ 성과 분석   │ ──────────▶ GPT-4o 원인 분석                │  │
│  │   └─────────────┘              가설 생성                      │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │   ┌─────────────┐                                            │  │
│  │   │ Phase 3     │  가설 기반 B 버전 생성                       │  │
│  │   │ A/B 생성   │ ──────────▶ ab_tests 테이블 등록             │  │
│  │   └─────────────┘              50:50 트래픽 시작              │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │   ┌─────────────┐                                            │  │
│  │   │ Phase 4     │  2주 후 통계적 검정                         │  │
│  │   │ 결과 평가   │ ──────────▶ 승자 결정 (p < 0.05)            │  │
│  │   └─────────────┘                                            │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │   ┌─────────────┐                                            │  │
│  │   │ Phase 5     │  B 승리 시: B → A 승격                      │  │
│  │   │ 자동 승격   │ ──────────▶ A 승리 시: B 삭제               │  │
│  │   └─────────────┘              테스트 종료                    │  │
│  │          │                                                   │  │
│  │          ▼                                                   │  │
│  │   ┌─────────────┐                                            │  │
│  │   │ Phase 6     │  Notion DB에 결과 전송                      │  │
│  │   │ 리포트     │ ──────────▶ 테스트 히스토리 기록             │  │
│  │   └─────────────┘                                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                       데이터 레이어                           │  │
│  │                                                              │  │
│  │   Cloud SQL (PostgreSQL)                                     │  │
│  │   ├── articles (글 + A/B 버전)                               │  │
│  │   ├── ab_tests (테스트 관리)                                 │  │
│  │   ├── article_metrics (GA 성과 데이터)                       │  │
│  │   ├── content_analysis (AI 분석 결과)                        │  │
│  │   └── generation_batches (배치 생성 추적)                    │  │
│  │                                                              │  │
│  │   Notion (리포트)                                            │  │
│  │   └── A/B 테스트 결과 DB                                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 데이터 흐름
```
[사용자 접속]
     │
     ▼
[GA4 이벤트 수집] ─────────────────────────────────────┐
     │                                                 │
     │ (3일 주기)                                      │
     ▼                                                 │
[fetch_ga_metrics.py] ──▶ article_metrics 테이블      │
     │                                                 │
     ▼                                                 │
[analyze_and_create_ab.py]                            │
     │                                                 │
     ├──▶ 하위 20% 글 추출                             │
     │                                                 │
     ├──▶ GPT-4o 분석 ──▶ content_analysis 테이블     │
     │                                                 │
     ├──▶ B 버전 생성 ──▶ articles 테이블 (version=B) │
     │                                                 │
     └──▶ 테스트 등록 ──▶ ab_tests 테이블             │
                                                       │
     (2주 후)                                          │
     │                                                 │
     ▼                                                 │
[evaluate_ab_tests.py]                                │
     │                                                 │
     ├──▶ 통계적 검정 (t-test)                        │
     │                                                 │
     ├──▶ 승자 결정                                   │
     │                                                 │
     ├──▶ 버전 승격/삭제                              │
     │                                                 │
     └──▶ Notion 리포트 ──────────────────────────────┘
```

---

## 4. SPEC 문서 구성

### 4.1 SPEC 목록

| SPEC ID | 제목 | 설명 | 의존성 |
|---------|------|------|--------|
| SPEC-001 | DB 기반 콘텐츠 서빙 | Next.js에서 DB 직접 조회, A/B 트래픽 분배 | - |
| SPEC-002 | GA4 데이터 수집 자동화 | Cloud Scheduler + GA4 API | SPEC-001 |
| SPEC-003 | AI 성과 분석 | GPT-4o 분석, 가설 생성 | SPEC-002 |
| SPEC-004 | A/B 테스트 자동 생성 | B 버전 생성, 테스트 시작 | SPEC-003 |
| SPEC-005 | A/B 결과 평가 및 승격 | 통계 검정, 자동 승격 | SPEC-004 |
| SPEC-006 | Notion 연동 리포트 | 결과 자동 전송 | SPEC-005 |

### 4.2 각 SPEC 요약

#### SPEC-001: DB 기반 콘텐츠 서빙
```
목표: MDX 파일 → PostgreSQL DB로 전환
주요 변경:
  - src/app/articles/[slug]/page.tsx: DB에서 글 조회
  - src/app/page.tsx: 글 목록 DB 조회
  - middleware.ts: A/B 쿠키 설정
산출물:
  - 수정된 page 컴포넌트들
  - DB 연동 API 함수
```

#### SPEC-002: GA4 데이터 수집 자동화
```
목표: 3일마다 GA4 데이터 자동 수집
주요 작업:
  - Cloud Scheduler 작업 생성
  - Cloud Functions 배포
  - 스크롤 깊이 이벤트 검증
산출물:
  - 배포된 Cloud Function
  - 스케줄러 설정
```

#### SPEC-003: AI 성과 분석
```
목표: 하위 20% 글 자동 분석 및 가설 생성
주요 작업:
  - OpenAI API 연동
  - 분석 프롬프트 최적화
  - 가설 생성 로직
산출물:
  - 최적화된 프롬프트
  - 분석 결과 저장 로직
```

#### SPEC-004: A/B 테스트 자동 생성
```
목표: AI 가설 기반 B 버전 자동 생성
주요 작업:
  - 섹션별 콘텐츠 수정 로직
  - B 버전 생성 및 저장
  - 테스트 시작 로직
산출물:
  - B 버전 생성 함수
  - 테스트 관리 로직
```

#### SPEC-005: A/B 결과 평가 및 승격
```
목표: 2주 후 통계적 검정으로 승자 결정
주요 작업:
  - t-test 통계 검정 구현
  - 최소 샘플 크기 검증
  - 자동 승격/롤백 로직
산출물:
  - 통계 검정 함수
  - 승격 자동화 스크립트
```

#### SPEC-006: Notion 연동 리포트
```
목표: A/B 테스트 결과 자동 전송
주요 작업:
  - Notion API 연동
  - 결과 DB 스키마 설계
  - 자동 리포트 생성
산출물:
  - Notion DB 템플릿
  - 리포트 전송 스크립트
```

---

## 5. 진행 계획

### 5.1 Phase 구분

| Phase | SPEC | 예상 기간 | 목표 |
|-------|------|----------|------|
| Phase 1 | SPEC-001, 002 | 1-2일 | DB 전환 + GA4 자동화 |
| Phase 2 | SPEC-003, 004 | 2-3일 | AI 분석 + A/B 생성 |
| Phase 3 | SPEC-005, 006 | 1-2일 | 자동 평가 + Notion 리포트 |

### 5.2 마일스톤

```
Week 1:
├── Day 1-2: SPEC-001 (DB 전환)
│   └── Next.js에서 DB 조회, A/B 트래픽 분배 적용
├── Day 3: SPEC-002 (GA4 자동화)
│   └── Cloud Scheduler + Functions 배포

Week 2:
├── Day 1-2: SPEC-003, 004 (AI 분석 + A/B)
│   └── OpenAI 연동, A/B 테스트 자동 생성
├── Day 3: SPEC-005 (자동 평가)
│   └── 통계 검정, 승격 로직
├── Day 4: SPEC-006 (Notion)
│   └── 결과 리포트 자동 전송

Week 3+:
└── 모니터링 및 최적화
    └── 실제 A/B 테스트 결과 확인
```

---

## 6. 기술 스택

### 6.1 백엔드
- **런타임**: Python 3.11+
- **DB**: PostgreSQL 15 (Cloud SQL)
- **AI**: OpenAI GPT-4o
- **API**: GA4 Data API, Notion API

### 6.2 프론트엔드
- **프레임워크**: Next.js 15
- **배포**: Firebase Hosting (정적 빌드)
- **스타일**: Tailwind CSS

### 6.3 인프라
- **클라우드**: Google Cloud Platform
- **스케줄링**: Cloud Scheduler
- **함수**: Cloud Functions (Python)

---

## 7. 리스크 및 대응

| 리스크 | 영향도 | 대응 방안 |
|--------|-------|----------|
| GA4 데이터 부족 | 높음 | 최소 2주 데이터 축적 후 A/B 시작 |
| AI 분석 품질 낮음 | 중간 | 프롬프트 반복 개선, 사람 검토 추가 |
| 통계적 유의성 미달 | 중간 | 샘플 크기 늘리거나 테스트 기간 연장 |
| 비용 초과 | 낮음 | OpenAI 호출 횟수 제한, 배치 처리 |

---

## 8. 다음 단계

1. **이 계획 문서 검토 및 승인**
2. **SPEC-001부터 순차적 작성**
3. **각 SPEC 완료 후 구현 진행**

---

## 부록

### A. 관련 파일 위치
```
fact-check/
├── docs/
│   ├── PLANNING.md          # 이 문서
│   └── specs/
│       ├── SPEC-001.md
│       ├── SPEC-002.md
│       └── ...
├── database/
│   └── migrations/
├── scripts/
└── src/
```

### B. 참고 링크
- [GA4 Data API 문서](https://developers.google.com/analytics/devguides/reporting/data/v1)
- [Notion API 문서](https://developers.notion.com/)
- [OpenAI API 문서](https://platform.openai.com/docs)
